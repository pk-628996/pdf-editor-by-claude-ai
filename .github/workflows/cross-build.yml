name: Cross-Platform Build and Test

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

env:
  BUILD_TYPE: Release
  QT_VERSION: '6.5.3'

jobs:
  build-linux:
    name: Build on Linux (Ubuntu)
    runs-on: ubuntu-22.04
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          cmake \
          ninja-build \
          libgl1-mesa-dev \
          libglu1-mesa-dev \
          libtesseract-dev \
          libssl-dev \
          libleptonica-dev \
          libxml2-dev \
          libfreetype6-dev \
          libharfbuzz-dev \
          libjpeg-dev \
          libopenjp2-7-dev \
          libgumbo-dev
    
    - name: Install Qt
      uses: jurplel/install-qt-action@v3
      with:
        version: ${{ env.QT_VERSION }}
        cache: true
        modules: 'qtbase qttools'
    
    - name: Configure CMake
      run: |
        cmake -B build \
          -G Ninja \
          -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
          -DBUILD_GUI=ON \
          -DBUILD_CLI=ON \
          -DBUILD_TESTS=ON
    
    - name: Build
      run: cmake --build build --parallel $(nproc)
    
    - name: Run tests
      working-directory: build
      run: ctest --output-on-failure --parallel $(nproc)
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: linux-build
        path: |
          build/bin/
          build/lib/
    
    - name: Upload test logs
      uses: actions/upload-artifact@v3
      if: failure()
      with:
        name: linux-test-logs
        path: build/Testing/Temporary/

  build-windows:
    name: Build on Windows
    runs-on: windows-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Install Qt
      uses: jurplel/install-qt-action@v3
      with:
        version: ${{ env.QT_VERSION }}
        cache: true
        arch: win64_msvc2019_64
        modules: 'qtbase qttools'
    
    - name: Setup MSVC
      uses: microsoft/setup-msbuild@v1.1
    
    - name: Install vcpkg dependencies
      run: |
        vcpkg install openssl:x64-windows
        vcpkg install tesseract:x64-windows
    
    - name: Configure CMake
      run: |
        cmake -B build `
          -G "Visual Studio 17 2022" `
          -A x64 `
          -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} `
          -DCMAKE_TOOLCHAIN_FILE="C:/vcpkg/scripts/buildsystems/vcpkg.cmake" `
          -DBUILD_GUI=ON `
          -DBUILD_CLI=ON `
          -DBUILD_TESTS=ON
    
    - name: Build
      run: cmake --build build --config ${{ env.BUILD_TYPE }} --parallel
    
    - name: Run tests
      working-directory: build
      run: ctest -C ${{ env.BUILD_TYPE }} --output-on-failure --parallel
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: windows-build
        path: |
          build/bin/${{ env.BUILD_TYPE }}/
          build/lib/${{ env.BUILD_TYPE }}/
    
    - name: Upload test logs
      uses: actions/upload-artifact@v3
      if: failure()
      with:
        name: windows-test-logs
        path: build/Testing/Temporary/

  build-macos:
    name: Build on macOS
    runs-on: macos-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Install dependencies
      run: |
        brew install \
          cmake \
          ninja \
          tesseract \
          openssl@3 \
          libxml2 \
          freetype \
          harfbuzz \
          jpeg \
          openjpeg \
          gumbo-parser
    
    - name: Install Qt
      uses: jurplel/install-qt-action@v3
      with:
        version: ${{ env.QT_VERSION }}
        cache: true
        modules: 'qtbase qttools'
    
    - name: Configure CMake
      run: |
        cmake -B build \
          -G Ninja \
          -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
          -DCMAKE_OSX_ARCHITECTURES="x86_64;arm64" \
          -DOpenSSL_ROOT=/usr/local/opt/openssl@3 \
          -DBUILD_GUI=ON \
          -DBUILD_CLI=ON \
          -DBUILD_TESTS=ON
    
    - name: Build
      run: cmake --build build --parallel $(sysctl -n hw.ncpu)
    
    - name: Run tests
      working-directory: build
      run: ctest --output-on-failure --parallel $(sysctl -n hw.ncpu)
    
    - name: Create DMG (if on main branch)
      if: github.ref == 'refs/heads/main'
      run: |
        cd build
        cpack -G DragNDrop
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: macos-build
        path: |
          build/bin/
          build/lib/
          build/*.dmg
    
    - name: Upload test logs
      uses: actions/upload-artifact@v3
      if: failure()
      with:
        name: macos-test-logs
        path: build/Testing/Temporary/

  code-quality:
    name: Code Quality Checks
    runs-on: ubuntu-22.04
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y clang-format clang-tidy cppcheck
    
    - name: Check code formatting
      run: |
        find src -name '*.cpp' -o -name '*.h' | xargs clang-format --dry-run --Werror
    
    - name: Run static analysis (cppcheck)
      run: |
        cppcheck --enable=all --suppress=missingIncludeSystem \
          --error-exitcode=1 \
          -I src/core/include \
          src/core/src/
    
    - name: Run clang-tidy
      run: |
        cmake -B build -DCMAKE_EXPORT_COMPILE_COMMANDS=ON
        find src -name '*.cpp' | xargs clang-tidy -p build

  documentation:
    name: Build Documentation
    runs-on: ubuntu-22.04
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Install Doxygen
      run: sudo apt-get update && sudo apt-get install -y doxygen graphviz
    
    - name: Generate documentation
      run: doxygen Doxyfile
    
    - name: Upload documentation
      uses: actions/upload-artifact@v3
      with:
        name: documentation
        path: docs/html/

  coverage:
    name: Code Coverage
    runs-on: ubuntu-22.04
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          cmake ninja-build lcov \
          libgl1-mesa-dev libtesseract-dev libssl-dev
    
    - name: Install Qt
      uses: jurplel/install-qt-action@v3
      with:
        version: ${{ env.QT_VERSION }}
        cache: true
    
    - name: Configure with coverage
      run: |
        cmake -B build \
          -G Ninja \
          -DCMAKE_BUILD_TYPE=Debug \
          -DCMAKE_CXX_FLAGS="--coverage" \
          -DCMAKE_EXE_LINKER_FLAGS="--coverage" \
          -DBUILD_TESTS=ON
    
    - name: Build
      run: cmake --build build --parallel
    
    - name: Run tests
      working-directory: build
      run: ctest --output-on-failure
    
    - name: Generate coverage report
      run: |
        lcov --capture --directory build --output-file coverage.info
        lcov --remove coverage.info '/usr/*' '*/third_party/*' '*/tests/*' --output-file coverage.info
        lcov --list coverage.info
    
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        files: ./coverage.info
        flags: unittests
        name: codecov-umbrella
